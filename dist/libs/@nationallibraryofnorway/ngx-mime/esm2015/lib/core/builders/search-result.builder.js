import { Hit } from './../models/hit';
import { Rect } from './../models/rect';
import { SearchResult } from './../models/search-result';
export class SearchResultBuilder {
    constructor(q, manifest, iiifSearchResult) {
        this.q = q;
        this.manifest = manifest;
        this.iiifSearchResult = iiifSearchResult;
    }
    build() {
        const searchResult = new SearchResult();
        searchResult.q = this.q;
        if (this.iiifSearchResult && this.iiifSearchResult.hits) {
            this.iiifSearchResult.hits.forEach((hit, index) => {
                const id = index;
                let canvasIndex = -1;
                let label;
                const rects = [];
                if (this.manifest.sequences && this.manifest.sequences[0].canvases) {
                    const resources = this.findResources(hit);
                    for (const resource of resources) {
                        canvasIndex = this.findSequenceIndex(resource);
                        label = this.findLabel(canvasIndex);
                        const on = resource.on;
                        if (on) {
                            const coords = on.substring(on.indexOf('=') + 1).split(',');
                            const rect = new Rect({
                                x: parseInt(coords[0], 10),
                                y: parseInt(coords[1], 10),
                                width: parseInt(coords[2], 10),
                                height: parseInt(coords[3], 10),
                            });
                            rects.push(rect);
                        }
                    }
                }
                searchResult.add(new Hit({
                    id: id,
                    index: canvasIndex,
                    label: label,
                    match: hit.match,
                    before: hit.before,
                    after: hit.after,
                    rects: rects,
                }));
            });
        }
        return searchResult;
    }
    findResources(hit) {
        const resources = [];
        if (hit.annotations) {
            for (const annotation of hit.annotations) {
                if (this.iiifSearchResult.resources) {
                    const res = this.iiifSearchResult.resources.find((r) => r['@id'] === annotation);
                    if (res) {
                        resources.push(res);
                    }
                }
            }
        }
        return resources;
    }
    findSequenceIndex(resource) {
        if (!this.manifest.sequences) {
            throw new Error('No sequences found!');
        }
        const firstSequence = this.getFirstSequence();
        const on = resource.on;
        if (on && firstSequence && firstSequence.canvases) {
            const id = on.substring(0, on.indexOf('#'));
            return firstSequence.canvases.findIndex((c) => c.id === id);
        }
        return -1;
    }
    findLabel(index) {
        if (index === -1) {
            return undefined;
        }
        else {
            const canvas = this.getFirstSequenceCanvas(index);
            return canvas ? canvas.label : undefined;
        }
    }
    getFirstSequence() {
        const sequences = this.manifest.sequences;
        return sequences ? sequences[0] : undefined;
    }
    getFirstSequenceCanvas(index) {
        const firstSequence = this.getFirstSequence();
        return firstSequence && firstSequence.canvases !== undefined
            ? firstSequence.canvases[index]
            : undefined;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLXJlc3VsdC5idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3gtbWltZS9zcmMvbGliL2NvcmUvYnVpbGRlcnMvc2VhcmNoLXJlc3VsdC5idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQU90QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRXpELE1BQU0sT0FBTyxtQkFBbUI7SUFDOUIsWUFDVSxDQUFTLEVBQ1QsUUFBa0IsRUFDbEIsZ0JBQWtDO1FBRmxDLE1BQUMsR0FBRCxDQUFDLENBQVE7UUFDVCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7SUFDekMsQ0FBQztJQUVHLEtBQUs7UUFDVixNQUFNLFlBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ3hDLFlBQVksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUN4QixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFO1lBQ3ZELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBWSxFQUFFLEtBQWEsRUFBRSxFQUFFO2dCQUNqRSxNQUFNLEVBQUUsR0FBVyxLQUFLLENBQUM7Z0JBQ3pCLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNyQixJQUFJLEtBQUssQ0FBQztnQkFDVixNQUFNLEtBQUssR0FBVyxFQUFFLENBQUM7Z0JBQ3pCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENB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RSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzVDLE9BQU8sYUFBYSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7U0FDN0Q7UUFDRCxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ1osQ0FBQztJQUVPLFNBQVMsQ0FBQyxLQUFhO1FBQzdCLElBQUksS0FBSyxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQ2hCLE9BQU8sU0FBUyxDQUFDO1NBQ2xCO2FBQU07WUFDTCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbEQsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztTQUMxQztJQUNILENBQUM7SUFFTyxnQkFBZ0I7UUFDdEIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUM7UUFDMUMsT0FBTyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQzlDLENBQUM7SUFFTyxzQkFBc0IsQ0FBQyxLQUFhO1FBQzFDLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzlDLE9BQU8sYUFBYSxJQUFJLGFBQWEsQ0FBQyxRQUFRLEtBQUssU0FBUztZQUMxRCxDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7WUFDL0IsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNoQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIaXQgfSBmcm9tICcuLy4uL21vZGVscy9oaXQnO1xuaW1wb3J0IHtcbiAgSGl0IGFzIElpaWZIaXQsXG4gIElpaWZTZWFyY2hSZXN1bHQsXG4gIFJlc291cmNlIGFzIElpaWZSZXNvdXJjZSxcbn0gZnJvbSAnLi8uLi9tb2RlbHMvaWlpZi1zZWFyY2gtcmVzdWx0JztcbmltcG9ydCB7IENhbnZhcywgTWFuaWZlc3QsIFNlcXVlbmNlIH0gZnJvbSAnLi8uLi9tb2RlbHMvbWFuaWZlc3QnO1xuaW1wb3J0IHsgUmVjdCB9IGZyb20gJy4vLi4vbW9kZWxzL3JlY3QnO1xuaW1wb3J0IHsgU2VhcmNoUmVzdWx0IH0gZnJvbSAnLi8uLi9tb2RlbHMvc2VhcmNoLXJlc3VsdCc7XG5cbmV4cG9ydCBjbGFzcyBTZWFyY2hSZXN1bHRCdWlsZGVyIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBxOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBtYW5pZmVzdDogTWFuaWZlc3QsXG4gICAgcHJpdmF0ZSBpaWlmU2VhcmNoUmVzdWx0OiBJaWlmU2VhcmNoUmVzdWx0XG4gICkge31cblxuICBwdWJsaWMgYnVpbGQoKTogU2VhcmNoUmVzdWx0IHtcbiAgICBjb25zdCBzZWFyY2hSZXN1bHQgPSBuZXcgU2VhcmNoUmVzdWx0KCk7XG4gICAgc2VhcmNoUmVzdWx0LnEgPSB0aGlzLnE7XG4gICAgaWYgKHRoaXMuaWlpZlNlYXJjaFJlc3VsdCAmJiB0aGlzLmlpaWZTZWFyY2hSZXN1bHQuaGl0cykge1xuICAgICAgdGhpcy5paWlmU2VhcmNoUmVzdWx0LmhpdHMuZm9yRWFjaCgoaGl0OiBJaWlmSGl0LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IGlkOiBudW1iZXIgPSBpbmRleDtcbiAgICAgICAgbGV0IGNhbnZhc0luZGV4ID0gLTE7XG4gICAgICAgIGxldCBsYWJlbDtcbiAgICAgICAgY29uc3QgcmVjdHM6IFJlY3RbXSA9IFtdO1xuICAgICAgICBpZiAodGhpcy5tYW5pZmVzdC5zZXF1ZW5jZXMgJiYgdGhpcy5tYW5pZmVzdC5zZXF1ZW5jZXNbMF0uY2FudmFzZXMpIHtcbiAgICAgICAgICBjb25zdCByZXNvdXJjZXMgPSB0aGlzLmZpbmRSZXNvdXJjZXMoaGl0KTtcbiAgICAgICAgICBmb3IgKGNvbnN0IHJlc291cmNlIG9mIHJlc291cmNlcykge1xuICAgICAgICAgICAgY2FudmFzSW5kZXggPSB0aGlzLmZpbmRTZXF1ZW5jZUluZGV4KHJlc291cmNlKTtcbiAgICAgICAgICAgIGxhYmVsID0gdGhpcy5maW5kTGFiZWwoY2FudmFzSW5kZXgpO1xuICAgICAgICAgICAgY29uc3Qgb24gPSByZXNvdXJjZS5vbjtcbiAgICAgICAgICAgIGlmIChvbikge1xuICAgICAgICAgICAgICBjb25zdCBjb29yZHMgPSBvbi5zdWJzdHJpbmcob24uaW5kZXhPZignPScpICsgMSkuc3BsaXQoJywnKTtcbiAgICAgICAgICAgICAgY29uc3QgcmVjdCA9IG5ldyBSZWN0KHtcbiAgICAgICAgICAgICAgICB4OiBwYXJzZUludChjb29yZHNbMF0sIDEwKSxcbiAgICAgICAgICAgICAgICB5OiBwYXJzZUludChjb29yZHNbMV0sIDEwKSxcbiAgICAgICAgICAgICAgICB3aWR0aDogcGFyc2VJbnQoY29vcmRzWzJdLCAxMCksXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBwYXJzZUludChjb29yZHNbM10sIDEwKSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIHJlY3RzLnB1c2gocmVjdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgc2VhcmNoUmVzdWx0LmFkZChcbiAgICAgICAgICBuZXcgSGl0KHtcbiAgICAgICAgICAgIGlkOiBpZCxcbiAgICAgICAgICAgIGluZGV4OiBjYW52YXNJbmRleCxcbiAgICAgICAgICAgIGxhYmVsOiBsYWJlbCxcbiAgICAgICAgICAgIG1hdGNoOiBoaXQubWF0Y2gsXG4gICAgICAgICAgICBiZWZvcmU6IGhpdC5iZWZvcmUsXG4gICAgICAgICAgICBhZnRlcjogaGl0LmFmdGVyLFxuICAgICAgICAgICAgcmVjdHM6IHJlY3RzLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHNlYXJjaFJlc3VsdDtcbiAgfVxuXG4gIHByaXZhdGUgZmluZFJlc291cmNlcyhoaXQ6IElpaWZIaXQpOiBJaWlmUmVzb3VyY2VbXSB7XG4gICAgY29uc3QgcmVzb3VyY2VzOiBJaWlmUmVzb3VyY2VbXSA9IFtdO1xuICAgIGlmIChoaXQuYW5ub3RhdGlvbnMpIHtcbiAgICAgIGZvciAoY29uc3QgYW5ub3RhdGlvbiBvZiBoaXQuYW5ub3RhdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMuaWlpZlNlYXJjaFJlc3VsdC5yZXNvdXJjZXMpIHtcbiAgICAgICAgICBjb25zdCByZXMgPSB0aGlzLmlpaWZTZWFyY2hSZXN1bHQucmVzb3VyY2VzLmZpbmQoXG4gICAgICAgICAgICAocjogSWlpZlJlc291cmNlKSA9PiByWydAaWQnXSA9PT0gYW5ub3RhdGlvblxuICAgICAgICAgICk7XG4gICAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgcmVzb3VyY2VzLnB1c2gocmVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc291cmNlcztcbiAgfVxuXG4gIHByaXZhdGUgZmluZFNlcXVlbmNlSW5kZXgocmVzb3VyY2U6IElpaWZSZXNvdXJjZSk6IG51bWJlciB7XG4gICAgaWYgKCF0aGlzLm1hbmlmZXN0LnNlcXVlbmNlcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBzZXF1ZW5jZXMgZm91bmQhJyk7XG4gICAgfVxuICAgIGNvbnN0IGZpcnN0U2VxdWVuY2UgPSB0aGlzLmdldEZpcnN0U2VxdWVuY2UoKTtcbiAgICBjb25zdCBvbiA9IHJlc291cmNlLm9uO1xuICAgIGlmIChvbiAmJiBmaXJzdFNlcXVlbmNlICYmIGZpcnN0U2VxdWVuY2UuY2FudmFzZXMpIHtcbiAgICAgIGNvbnN0IGlkID0gb24uc3Vic3RyaW5nKDAsIG9uLmluZGV4T2YoJyMnKSk7XG4gICAgICByZXR1cm4gZmlyc3RTZXF1ZW5jZS5jYW52YXNlcy5maW5kSW5kZXgoKGMpID0+IGMuaWQgPT09IGlkKTtcbiAgICB9XG4gICAgcmV0dXJuIC0xO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kTGFiZWwoaW5kZXg6IG51bWJlcik6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5nZXRGaXJzdFNlcXVlbmNlQ2FudmFzKGluZGV4KTtcbiAgICAgIHJldHVybiBjYW52YXMgPyBjYW52YXMubGFiZWwgOiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRGaXJzdFNlcXVlbmNlKCk6IFNlcXVlbmNlIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBzZXF1ZW5jZXMgPSB0aGlzLm1hbmlmZXN0LnNlcXVlbmNlcztcbiAgICByZXR1cm4gc2VxdWVuY2VzID8gc2VxdWVuY2VzWzBdIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRGaXJzdFNlcXVlbmNlQ2FudmFzKGluZGV4OiBudW1iZXIpOiBDYW52YXMgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGZpcnN0U2VxdWVuY2UgPSB0aGlzLmdldEZpcnN0U2VxdWVuY2UoKTtcbiAgICByZXR1cm4gZmlyc3RTZXF1ZW5jZSAmJiBmaXJzdFNlcXVlbmNlLmNhbnZhc2VzICE9PSB1bmRlZmluZWRcbiAgICAgID8gZmlyc3RTZXF1ZW5jZS5jYW52YXNlc1tpbmRleF1cbiAgICAgIDogdW5kZWZpbmVkO1xuICB9XG59XG4iXX0=